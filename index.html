<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Task Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-light: #667eea;
            --primary-dark: #764ba2;
            --secondary-light: #f093fb;
            --secondary-dark: #f5576c;
            --bg-light: #f8fafc;
            --bg-dark: #0f172a;
            --surface-light: #ffffff;
            --surface-dark: #1e293b;
            --text-light: #334155;
            --text-dark: #e2e8f0;
            --border-light: #e2e8f0;
            --border-dark: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --urgent: #dc2626;
            --important: #7c3aed;
            --normal: #6b7280;
        }

        [data-theme="light"] {
            --bg: var(--bg-light);
            --surface: var(--surface-light);
            --text: var(--text-light);
            --border: var(--border-light);
            --primary: var(--primary-light);
            --secondary: var(--secondary-light);
        }

        [data-theme="dark"] {
            --bg: var(--bg-dark);
            --surface: var(--surface-dark);
            --text: var(--text-dark);
            --border: var(--border-dark);
            --primary: var(--primary-dark);
            --secondary: var(--secondary-dark);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 10px;
            min-height: 100vh;
        }

        .header {
            background: var(--surface);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-align: center;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .theme-toggle {
            background: none;
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-tabs {
            display: flex;
            background: var(--surface);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .nav-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            color: var(--text);
        }

        .nav-tab.active {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .task-list {
            background: var(--surface);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .task-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            position: relative;
        }

        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .task-item.completed {
            opacity: 0.7;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .task-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
            word-break: break-word;
            color: var(--text);
        }

        .task-title.completed {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .task-description {
            color: var(--text);
            opacity: 0.8;
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .task-date, .task-priority, .task-tag {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 500;
        }

        .task-date {
            background: var(--primary);
            color: white;
        }

        .task-priority {
            color: white;
        }

        .priority-urgent { background: var(--urgent); }
        .priority-important { background: var(--important); }
        .priority-normal { background: var(--normal); }

        .task-tag {
            background: var(--secondary);
            color: white;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .task-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            color: var(--text);
        }

        .task-btn:hover {
            transform: translateY(-1px);
        }

        .task-btn.complete {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .task-btn.delete {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        .progress-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .progress-bar {
            background: var(--border);
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .habit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .habit-streak {
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text);
            opacity: 0.7;
        }

        .empty-state .emoji {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideDown 0.3s ease;
            max-width: 90%;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); }
            to { transform: translateX(-50%) translateY(0); }
        }

        .filter-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .habit-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .task-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .stats {
                flex-wrap: wrap;
                gap: 15px;
            }

            .habit-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .habit-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìù Personal Task Manager</h1>
            <div class="header-controls">
                <button class="theme-toggle" id="themeToggle">üåì Theme</button>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number" id="totalTasks">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="completedTasks">0</div>
                        <div class="stat-label">Done</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="pendingTasks">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="tasks">Tasks</button>
            <button class="nav-tab" data-tab="habits">Habits</button>
            <button class="nav-tab" data-tab="progress">Progress</button>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks" class="tab-content active">
            <!-- Add Task Form -->
            <div class="form-card">
                <div class="form-group">
                    <label for="taskTitle">Task Title *</label>
                    <input type="text" id="taskTitle" class="form-control" placeholder="Enter task title" required>
                </div>
                <div class="form-group">
                    <label for="taskDescription">Description</label>
                    <textarea id="taskDescription" class="form-control" rows="3" placeholder="Task description (optional)"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskDate">Due Date</label>
                        <input type="date" id="taskDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">Priority</label>
                        <select id="taskPriority" class="form-control">
                            <option value="normal">Normal</option>
                            <option value="important">Important</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="taskTags">Tags (comma separated)</label>
                    <input type="text" id="taskTags" class="form-control" placeholder="work, personal, shopping">
                </div>
                <button class="btn" id="addTaskBtn">‚ûï Add Task</button>
            </div>

            <!-- Task Filters -->
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="pending">Pending</button>
                <button class="filter-btn" data-filter="completed">Completed</button>
                <button class="filter-btn" data-filter="urgent">Urgent</button>
                <button class="filter-btn" data-filter="today">Today</button>
                <button class="filter-btn" data-filter="overdue">Overdue</button>
            </div>

            <!-- Task List -->
            <div class="task-list" id="taskList">
                <div class="empty-state">
                    <span class="emoji">üìù</span>
                    <p>No tasks yet. Add your first task above!</p>
                </div>
            </div>
        </div>

        <!-- Habits Tab -->
        <div id="habits" class="tab-content">
            <!-- Add Habit Form -->
            <div class="form-card">
                <div class="form-group">
                    <label for="habitTitle">Habit Name *</label>
                    <input type="text" id="habitTitle" class="form-control" placeholder="Enter habit name" required>
                </div>
                <div class="form-group">
                    <label for="habitTarget">Daily Target</label>
                    <input type="number" id="habitTarget" class="form-control" placeholder="1" min="1" value="1">
                </div>
                <button class="btn" id="addHabitBtn">‚ûï Add Habit</button>
            </div>

            <!-- Habit List -->
            <div class="task-list" id="habitList">
                <div class="empty-state">
                    <span class="emoji">üéØ</span>
                    <p>No habits tracked yet. Start building good habits!</p>
                </div>
            </div>
        </div>

        <!-- Progress Tab -->
        <div id="progress" class="tab-content">
            <!-- Overall Progress -->
            <div class="progress-card">
                <h3>Daily Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="dailyProgress" style="width: 0%"></div>
                </div>
                <p id="dailyProgressText">0% Complete</p>
            </div>

            <div class="progress-card">
                <h3>Weekly Summary</h3>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number" id="weeklyCompleted">0</div>
                        <div class="stat-label">Tasks Done</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="weeklyHabits">0</div>
                        <div class="stat-label">Habits</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="weeklyStreak">0</div>
                        <div class="stat-label">Best Streak</div>
                    </div>
                </div>
            </div>

            <!-- Habit Progress -->
            <div class="progress-card">
                <h3>Habit Streaks</h3>
                <div id="habitProgress">
                    <div class="empty-state">
                        <span class="emoji">üìä</span>
                        <p>Start tracking habits to see progress!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App State
        let tasks = [];
        let habits = [];
        let habitProgress = {};
        let currentFilter = 'all';

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...');
            loadData();
            setupEventListeners();
            loadTheme();
            setDefaultDate();
            checkNotifications();
            updateDisplay();
        });

        // Load data from localStorage
        function loadData() {
            try {
                tasks = JSON.parse(localStorage.getItem('tasks')) || [];
                habits = JSON.parse(localStorage.getItem('habits')) || [];
                habitProgress = JSON.parse(localStorage.getItem('habitProgress')) || {};
                console.log('Data loaded:', { tasks: tasks.length, habits: habits.length });
            } catch (e) {
                console.error('Error loading data:', e);
                tasks = [];
                habits = [];
                habitProgress = {};
            }
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });

            // Add task button
            document.getElementById('addTaskBtn').addEventListener('click', addTask);

            // Add habit button
            document.getElementById('addHabitBtn').addEventListener('click', addHabit);

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => filterTasks(e.target.dataset.filter));
            });

            // Enter key support for forms
            document.getElementById('taskTitle').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });

            document.getElementById('habitTitle').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addHabit();
            });
        }

        // Theme Management
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            showNotification(`Switched to ${newTheme} mode! ‚ú®`);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // Tab Management
        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update progress when switching to progress tab
            if (tabName === 'progress') {
                updateProgress();
            }
        }

        // Task Management
        function addTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const date = document.getElementById('taskDate').value;
            const priority = document.getElementById('taskPriority').value;
            const tagsInput = document.getElementById('taskTags').value.trim();

            if (!title) {
                showNotification('Please enter a task title! üìù', 'error');
                return;
            }

            const task = {
                id: Date.now(),
                title,
                description,
                date,
                priority,
                tags: tagsInput ? tagsInput.split(',').map(tag => tag.trim()) : [],
                completed: false,
                createdAt: new Date().toISOString()
            };

            tasks.unshift(task);
            saveTasks();
            clearTaskForm();
            updateDisplay();
            showNotification('Task added successfully! üéâ');
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                task.completedAt = task.completed ? new Date().toISOString() : null;
                saveTasks();
                updateDisplay();
                showNotification(task.completed ? 'Task completed! üéâ' : 'Task marked as pending üìù');
            }
        }

        function deleteTask(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(t => t.id !== id);
                saveTasks();
                updateDisplay();
                showNotification('Task deleted! üóëÔ∏è');
            }
        }

        function filterTasks(filter) {
            currentFilter = filter;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            renderTasks();
        }

        function getFilteredTasks() {
            const today = new Date().toISOString().split('T')[0];
            
            switch (currentFilter) {
                case 'pending':
                    return tasks.filter(task => !task.completed);
                case 'completed':
                    return tasks.filter(task => task.completed);
                case 'urgent':
                    return tasks.filter(task => task.priority === 'urgent');
                case 'today':
                    return tasks.filter(task => task.date === today);
                case 'overdue':
                    return tasks.filter(task => task.date && task.date < today && !task.completed);
                default:
                    return tasks;
            }
        }

        function renderTasks() {
            const taskList = document.getElementById('taskList');
            const filteredTasks = getFilteredTasks();

            if (filteredTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <span class="emoji">üìù</span>
                        <p>${getEmptyMessage()}</p>
                    </div>
                `;
                return;
            }

            taskList.innerHTML = filteredTasks.map(task => `
                <div class="task-item ${task.completed ? 'completed' : ''}" data-priority="${task.priority}">
                    <div class="task-header">
                        <div class="task-title ${task.completed ? 'completed' : ''}">${escapeHtml(task.title)}</div>
                    </div>
                    ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                    <div class="task-meta">
                        ${task.date ? `<span class="task-date">üìÖ ${formatDate(task.date)}</span>` : ''}
                        <span class="task-priority priority-${task.priority}">
                            ${getPriorityIcon(task.priority)} ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                        </span>
                        ${task.tags.map(tag => `<span class="task-tag">üè∑Ô∏è ${escapeHtml(tag)}</span>`).join('')}
                    </div>
                    <div class="task-actions">
                        <button class="task-btn complete" onclick="toggleTask(${task.id})">
                            ${task.completed ? '‚Ü©Ô∏è Undo' : '‚úÖ Done'}
                        </button>
                        <button class="task-btn delete" onclick="deleteTask(${task.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Habit Management
        function addHabit() {
            const title = document.getElementById('habitTitle').value.trim();
            const target = parseInt(document.getElementById('habitTarget').value) || 1;

            if (!title) {
                showNotification('Please enter a habit name! üéØ', 'error');
                return;
            }

            const habit = {
                id: Date.now(),
                title,
                target,
                createdAt: new Date().toISOString()
            };

            habits.push(habit);
            saveHabits();
            clearHabitForm();
            updateDisplay();
            showNotification('Habit added successfully! üåü');
        }

        function trackHabit(id) {
            const today = new Date().toISOString().split('T')[0];
            
            if (!habitProgress[id]) {
                habitProgress[id] = {};
            }
            
            if (!habitProgress[id][today]) {
                habitProgress[id][today] = 0;
            }
            
            const habit = habits.find(h => h.id === id);
            if (habit && habitProgress[id][today] < habit.target) {
                habitProgress[id][today]++;
                saveHabitProgress();
                updateDisplay();
                showNotification('Habit progress updated! üéØ');
            }
        }

        function deleteHabit(id) {
            if (confirm('Are you sure you want to delete this habit?')) {
                habits = habits.filter(h => h.id !== id);
                delete habitProgress[id];
                saveHabits();
                saveHabitProgress();
                updateDisplay();
                showNotification('Habit deleted! üóëÔ∏è');
            }
        }

        function renderHabits() {
            const habitList = document.getElementById('habitList');
            const today = new Date().toISOString().split('T')[0];

            if (habits.length === 0) {
                habitList.innerHTML = `
                    <div class="empty-state">
                        <span class="emoji">üéØ</span>
                        <p>No habits tracked yet. Start building good habits!</p>
                    </div>
                `;
                return;
            }

            habitList.innerHTML = habits.map(habit => {
                const todayProgress = habitProgress[habit.id]?.[today] || 0;
                const streak = getHabitStreak(habit.id);
                const isComplete = todayProgress >= habit.target;
                
                return `
                    <div class="habit-item">
                        <div>
                            <div class="task-title">${escapeHtml(habit.title)}</div>
                            <small>Progress: ${todayProgress}/${habit.target} ${isComplete ? '‚úÖ' : '‚è≥'}</small>
                        </div>
                        <div class="habit-actions">
                            <span class="habit-streak">üî• ${streak} days</span>
                            <button class="task-btn" onclick="trackHabit(${habit.id})" ${isComplete ? 'disabled' : ''}>
                                ${isComplete ? '‚úÖ Done' : '‚ûï Track'}
                            </button>
                            <button class="task-btn delete" onclick="deleteHabit(${habit.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getHabitStreak(habitId) {
            if (!habitProgress[habitId]) return 0;
            
            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toISOString().split('T')[0];
                
                const habit = habits.find(h => h.id === habitId);
                const progress = habitProgress[habitId][dateStr] || 0;
                
                if (habit && progress >= habit.target) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // Progress and Stats
        function updateStats() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.completed).length;
            const pending = total - completed;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('pendingTasks').textContent = pending;
        }

        function updateProgress() {
            // Daily progress
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = tasks.filter(t => t.date === today);
            const todayCompleted = todayTasks.filter(t => t.completed).length;
            const dailyProgressPercent = todayTasks.length > 0 ? (todayCompleted / todayTasks.length) * 100 : 0;
            
            document.getElementById('dailyProgress').style.width = `${dailyProgressPercent}%`;
            document.getElementById('dailyProgressText').textContent = `${Math.round(dailyProgressPercent)}% Complete (${todayCompleted}/${todayTasks.length})`;

            // Weekly stats
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weeklyCompleted = tasks.filter(t => {
                if (!t.completedAt) return false;
                const taskDate = new Date(t.completedAt);
                return taskDate >= weekStart && t.completed;
            }).length;

            document.getElementById('weeklyCompleted').textContent = weeklyCompleted;
            document.getElementById('weeklyHabits').textContent = habits.length;
            
            // Best streak
            let bestStreak = 0;
            habits.forEach(habit => {
                const streak = getHabitStreak(habit.id);
                if (streak > bestStreak) bestStreak = streak;
            });
            document.getElementById('weeklyStreak').textContent = bestStreak;

            // Habit progress
            renderHabitProgress();
        }

        function renderHabitProgress() {
            const habitProgressDiv = document.getElementById('habitProgress');
            
            if (habits.length === 0) {
                habitProgressDiv.innerHTML = `
                    <div class="empty-state">
                        <span class="emoji">üìä</span>
                        <p>Start tracking habits to see progress!</p>
                    </div>
                `;
                return;
            }

            habitProgressDiv.innerHTML = habits.map(habit => {
                const streak = getHabitStreak(habit.id);
                const today = new Date().toISOString().split('T')[0];
                const todayProgress = habitProgress[habit.id]?.[today] || 0;
                const progressPercent = (todayProgress / habit.target) * 100;
                
                return `
                    <div class="habit-item">
                        <div style="flex: 1;">
                            <div class="task-title">${escapeHtml(habit.title)}</div>
                            <div class="progress-bar" style="margin: 5px 0;">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <small>Today: ${todayProgress}/${habit.target}</small>
                        </div>
                        <span class="habit-streak">üî• ${streak}</span>
                    </div>
                `;
            }).join('');
        }

        // Notifications
        function checkNotifications() {
            const today = new Date().toISOString().split('T')[0];
            const overdueTasks = tasks.filter(t => t.date && t.date < today && !t.completed);
            
            if (overdueTasks.length > 0) {
                setTimeout(() => {
                    showNotification(`‚ö†Ô∏è You have ${overdueTasks.length} overdue task(s)!`, 'warning');
                }, 1000);
            }

            // Check for today's tasks
            const todayTasks = tasks.filter(t => t.date === today && !t.completed);
            if (todayTasks.length > 0) {
                setTimeout(() => {
                    showNotification(`üìÖ You have ${todayTasks.length} task(s) due today!`, 'info');
                }, 2000);
            }
        }

        function showNotification(message, type = 'success') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            if (type === 'error') {
                notification.style.background = 'var(--error)';
            } else if (type === 'warning') {
                notification.style.background = 'var(--warning)';
            } else if (type === 'info') {
                notification.style.background = 'var(--primary)';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            
            const dateStr = dateString;
            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (dateStr === todayStr) {
                return 'Today';
            } else if (dateStr === tomorrowStr) {
                return 'Tomorrow';
            } else if (dateStr === yesterdayStr) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
        }

        function getPriorityIcon(priority) {
            switch (priority) {
                case 'urgent': return 'üö®';
                case 'important': return '‚≠ê';
                default: return 'üìã';
            }
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('taskDate').value = today;
        }

        function clearTaskForm() {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskTags').value = '';
            document.getElementById('taskPriority').value = 'normal';
            setDefaultDate();
        }

        function clearHabitForm() {
            document.getElementById('habitTitle').value = '';
            document.getElementById('habitTarget').value = '1';
        }

        function getEmptyMessage() {
            switch (currentFilter) {
                case 'pending':
                    return 'No pending tasks! Great job! üéâ';
                case 'completed':
                    return 'No completed tasks yet. Get started! üí™';
                case 'urgent':
                    return 'No urgent tasks. You\'re on top of things! üëç';
                case 'today':
                    return 'No tasks due today. Enjoy your day! ‚òÄÔ∏è';
                case 'overdue':
                    return 'No overdue tasks! You\'re up to date! ‚ú®';
                default:
                    return 'No tasks yet. Add your first task above! üìù';
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function updateDisplay() {
            renderTasks();
            renderHabits();
            updateStats();
            updateProgress();
        }

        // Storage Functions
        function saveTasks() {
            try {
                localStorage.setItem('tasks', JSON.stringify(tasks));
            } catch (e) {
                console.error('Error saving tasks:', e);
                showNotification('Error saving tasks!', 'error');
            }
        }

        function saveHabits() {
            try {
                localStorage.setItem('habits', JSON.stringify(habits));
            } catch (e) {
                console.error('Error saving habits:', e);
                showNotification('Error saving habits!', 'error');
            }
        }

        function saveHabitProgress() {
            try {
                localStorage.setItem('habitProgress', JSON.stringify(habitProgress));
            } catch (e) {
                console.error('Error saving habit progress:', e);
                showNotification('Error saving progress!', 'error');
            }
        }

        // Global functions for onclick handlers
        window.toggleTask = toggleTask;
        window.deleteTask = deleteTask;
        window.trackHabit = trackHabit;
        window.deleteHabit = deleteHabit;

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to add task/habit
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const activeTab = document.querySelector('.tab-content.active').id;
                if (activeTab === 'tasks') {
                    addTask();
                } else if (activeTab === 'habits') {
                    addHabit();
                }
                e.preventDefault();
            }
            
            // ESC to clear forms
            if (e.key === 'Escape') {
                clearTaskForm();
                clearHabitForm();
            }
        });

        // Auto-save and cleanup
        setInterval(() => {
            // Clean up old habit progress data (older than 1 year)
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const cutoffDate = oneYearAgo.toISOString().split('T')[0];
            
            Object.keys(habitProgress).forEach(habitId => {
                const habitData = habitProgress[habitId];
                Object.keys(habitData).forEach(date => {
                    if (date < cutoffDate) {
                        delete habitData[date];
                    }
                });
            });
            
            saveHabitProgress();
        }, 300000); // Run every 5 minutes

        // Service Worker for offline functionality
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'task-manager-v1';
                const urlsToCache = ['/'];
                
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                    );
                });
                
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request);
                            })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        // Initialize notifications permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                console.log('Notification permission:', permission);
            });
        }

        // Export data functionality
        function exportData() {
            const data = {
                tasks,
                habits,
                habitProgress,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `task-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            showNotification('Data exported successfully! üìÑ');
        }

        // Make export function globally available
        window.exportData = exportData;
    </script>
</body>
</html>